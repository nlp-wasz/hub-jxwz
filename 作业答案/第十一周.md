[TOC]

## 多模态RAG系统接口设计

### I. 权限管理模块 (Authorization & Access)

| **模块/功能** | **接口定义**        | **HTTP方法** | **描述**                            |
| ------------- | ------------------- | ------------ | ----------------------------------- |
| **用户登录**  | `/auth/login`       | `POST`       | 获取用户Token。                     |
| **用户注册**  | `/auth/register`    | `POST`       | 注册新用户。                        |
| **分配权限**  | `/permission/grant` | `POST`       | 管理员为用户分配知识库的读/写权限。 |

### II. 数据管理接口 (Data Management API)

#### 1. 知识库维度 (Knowledge Base Level)

| **接口定义**         | **HTTP方法** | **传入参数 (Request Body)**                                  | **返回结果 (Response Body)**                                 | **权限要求**       | **描述**                   |
| -------------------- | ------------ | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------ | -------------------------- |
| `/kb/create`         | `POST`       | `kb_name` (str), `description` (str), `owner_id` (int), `read_users` (list[int]), `write_users` (list[int]) | `kb_id` (int), `message` (str)                               | 需管理员或特定权限 | **创建**新的知识库。       |
| `/kb/{kb_id}`        | `GET`        | (URL Path)                                                   | `kb_id`, `kb_name`, `description`, `owner_id`, `read_users`, `write_users`, `status` | 读权限             | **获取**知识库详细信息。   |
| `/kb/{kb_id}/update` | `POST`       | `kb_name` (str, optional), `description` (str, optional), `add_read_users` (list[int], optional), `remove_read_users` (list[int], optional) | `message` (str)                                              | 写权限             | **更新**知识库信息和权限。 |
| `/kb/{kb_id}/delete` | `POST`       | (URL Path)                                                   | `message` (str)                                              | 所有者或管理员     | **删除**知识库。           |

#### 2. 文档维度 (Document Level)

| **接口定义**           | **HTTP方法** | **传入参数 (Request Body)**                                  | **返回结果 (Response Body)**                                 | **权限要求** | **描述**                                         |
| ---------------------- | ------------ | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------ | ------------------------------------------------ |
| `/doc/upload`          | `POST`       | `kb_id` (int), `file` (multipart/form-data), `doc_name` (str, optional) | `doc_id` (int), `message` (str)                              | 写权限       | **上传**文件并自动开始切分和多模态识别（异步）。 |
| `/doc/{doc_id}`        | `GET`        | (URL Path)                                                   | `doc_id`, `kb_id`, `doc_name`, `upload_time`, `chunk_count`, `process_status` | 读权限       | **获取**文档详情及处理状态。                     |
| `/doc/{doc_id}/delete` | `POST`       | (URL Path)                                                   | `message` (str)                                              | 写权限       | **删除**文档及其所有Chunk。                      |

#### 3. Chunk维度 (Chunk Level)

| **接口定义**           | **HTTP方法** | **传入参数 (Request Body)**                                  | **返回结果 (Response Body)**                                 | **权限要求** | **描述**                            |
| ---------------------- | ------------ | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------ | ----------------------------------- |
| `/chunk/{chunk_id}`    | `GET`        | (URL Path)                                                   | `chunk_id` (int), `doc_id` (int), `kb_id` (int), `chunk_index` (int), `original_content` (str), `image_url` (str, optional), `qwen_vl_description` (str, optional), `vector_id` (str) | 读权限       | **获取**特定多模态Chunk的详细内容。 |
| `/doc/{doc_id}/chunks` | `GET`        | `doc_id` (URL Path), `page` (int, query), `page_size` (int, query) | `total`, `page`, `chunks` (list of simplified chunk objects) | 读权限       | **分页获取**文档下的所有Chunk列表。 |

### III. 多模态检索接口 (Multi-modal Retrieval API)

| **接口定义**       | **HTTP方法** | **传入参数 (Request Body)**                                  | **返回结果 (Response Body)**                                 | **权限要求** | **描述**                                                     |
| ------------------ | ------------ | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------ | ------------------------------------------------------------ |
| `/search/retrieve` | `POST`       | `kb_ids` (list[int]), `query_text` (str, optional), `query_image_url` (str, optional), `top_k` (int, default=5) | **`retrieved_chunks`** (list of objects): * `chunk_id` * `doc_id` * `score` (float) * `original_content` * `qwen_vl_description` * `image_url` | 读权限       | **核心检索**接口。支持纯文本、纯图片（通过URL）或图文混合查询。 |

### IV. 多模态问答接口 (Multi-modal Q&A API)

| **接口定义**               | **HTTP方法** | **传入参数 (Request Body)**                                  | **返回结果 (Response Body)**                                 | **权限要求** | **描述**                                                     |
| -------------------------- | ------------ | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------ | ------------------------------------------------------------ |
| `/qa/answer`               | `POST`       | `kb_ids` (list[int]), `question_text` (str), `question_image_url` (str, optional), `session_id` (str, optional), `stream` (bool, optional) | **`answer`** (str), **`source_chunks`** (list of simplified retrieved chunks) | 读权限       | **核心问答**接口。基于检索到的多模态信息生成答案。支持会话历史（通过`session_id`）和流式输出（通过`stream`）。 |
| `/qa/history/{session_id}` | `GET`        | (URL Path)                                                   | **`messages`** (list of Q&A objects)                         | 读权限       | **获取**特定会话的历史记录。                                 |



## 数据存储 Schema 设计

将数据分为三个部分进行存储：

1. **MySQL 关系型数据库 (Metadata & Access Control):** 存储知识库、文档、Chunk 的元数据，以及用户、权限和会话历史等结构化信息。
2. **Milvus 向量数据库 (Multi-modal Vectors):** 存储多模态 Chunk 的向量嵌入，用于高效的相似性检索。
3. **对象存储 (Object Storage, e.g., S3/OSS):** 存储原始大文件和提取出的图片文件（不属于数据库 Schema，但实际项目中必须使用）。



### I. MySQL Schema 设计

#### 1. `users` (用户表)

| **字段名**        | **数据类型**   | **约束**                    | **描述**       |
| ----------------- | -------------- | --------------------------- | -------------- |
| `user_id`         | `INT`          | Primary Key, Auto Increment | 用户唯一ID。   |
| `username`        | `VARCHAR(100)` | Unique                      | 用户名/邮箱。  |
| `hashed_password` | `VARCHAR(255)` | Not Null                    | 加密后的密码。 |
| `is_admin`        | `BOOLEAN`      | Default 0                   | 是否为管理员。 |

#### 2. `knowledge_bases` (知识库表)

| **字段名**    | **数据类型**   | **约束**                    | **描述**       |
| ------------- | -------------- | --------------------------- | -------------- |
| `kb_id`       | `INT`          | Primary Key, Auto Increment | 知识库唯一ID。 |
| `kb_name`     | `VARCHAR(255)` | Not Null                    | 知识库名称。   |
| `description` | `TEXT`         | Nullable                    | 知识库描述。   |
| `owner_id`    | `INT`          | Foreign Key (users.user_id) | 知识库所有者。 |
| `created_at`  | `DATETIME`     | Not Null                    | 创建时间。     |

#### 3. `kb_permissions` (知识库权限表)

| **字段名**                             | **数据类型** | **约束**                            | **描述**                                   |
| -------------------------------------- | ------------ | ----------------------------------- | ------------------------------------------ |
| `perm_id`                              | `INT`        | Primary Key, Auto Increment         | 权限记录ID。                               |
| `kb_id`                                | `INT`        | Foreign Key (knowledge_bases.kb_id) | 知识库ID。                                 |
| `user_id`                              | `INT`        | Foreign Key (users.user_id)         | 用户ID。                                   |
| `read_access`                          | `BOOLEAN`    | Not Null, Default 0                 | 是否有读取权限。                           |
| `write_access`                         | `BOOLEAN`    | Not Null, Default 0                 | 是否有写入/管理权限。                      |

#### 4. `documents` (文档表)

| **字段名**    | **数据类型**   | **约束**                                     | **描述**                           |
| ------------- | -------------- | -------------------------------------------- | ---------------------------------- |
| `doc_id`      | `INT`          | Primary Key, Auto Increment                  | 文档唯一ID。                       |
| `kb_id`       | `INT`          | Foreign Key (knowledge_bases.kb_id)          | 所属知识库ID。                     |
| `doc_name`    | `VARCHAR(255)` | Not Null                                     | 文档名。                           |
| `file_path`   | `VARCHAR(512)` | Not Null                                     | 对象存储（如S3）中的原始文件路径。 |
| `status`      | `ENUM`         | 'UPLOADING', 'PROCESSING', 'READY', 'FAILED' | 文档处理状态。                     |
| `uploaded_by` | `INT`          | Foreign Key (users.user_id)                  | 上传者。                           |
| `uploaded_at` | `DATETIME`     | Not Null                                     | 上传时间。                         |

#### 5. `chunks` (多模态 Chunk 表)

这是最核心的元数据表，对应 Milvus 中的记录。

| **字段名**           | **数据类型**   | **约束**                       | **描述**                                                     |
| -------------------- | -------------- | ------------------------------ | ------------------------------------------------------------ |
| **`chunk_id`**       | `INT`          | Primary Key, Auto Increment    | **Chunk唯一ID，也是Milvus中的`id`。**                        |
| `doc_id`             | `INT`          | Foreign Key (documents.doc_id) | 所属文档ID。                                                 |
| `kb_id`              | `INT`          | Index                          | 所属知识库ID (冗余存储，方便检索)。                          |
| `chunk_index`        | `INT`          | Not Null                       | 在文档中的序号。                                             |
| `original_content`   | `TEXT`         | Nullable                       | 原始文本内容。                                               |
| `image_url`          | `VARCHAR(512)` | Nullable                       | 提取出的图片在对象存储中的路径。                             |
| **`vl_description`** | `TEXT`         | Nullable                       | **Qwen-VL或DeepSeek-OCR对Chunk内容的全面多模态识别结果（文本描述）。** |
| `vector_id`          | `VARCHAR(255)` | Not Null                       | Milvus中的向量ID (通常与`chunk_id`保持一致)。                |

### II. Milvus Schema 

| **字段名**             | **数据类型**                | **属性**     | **描述**                                                     |
| ---------------------- | --------------------------- | ------------ | ------------------------------------------------------------ |
| **`chunk_id`**         | `Int64`                     | Primary Key  | 对应 MySQL `chunks.chunk_id`。                               |
| `kb_id`                | `Int64`                     | Scalar       | **知识库ID**。用于过滤检索范围。                             |
| `doc_id`               | `Int64`                     | Scalar       | **文档ID**。用于溯源。                                       |
| `chunk_index`          | `Int64`                     | Scalar       | Chunk在文档中的索引。                                        |
| `original_content`     | `VARCHAR` (Max Size: 65535) | Scalar       | **原始文本内容**。保留在 Milvus 中，作为 RAG 的直接上下文。  |
| **`image_url`**        | `VARCHAR` (Max Size: 512)   | Scalar       | 图片在对象存储中的路径。保留用于展示或大模型二次调用。       |
| `vl_description`  | `VARCHAR` (Max Size: 65535) | Scalar       | **Qwen-VL识别结果的文本描述**。作为 RAG 的 enriched 上下文。 |
| **`text_vector`**      | `FLOAT_VECTOR`              | Vector Field | **【文本】向量**：仅使用 `original_content` 或 `qwen_vl_description` 进行文本编码（例如使用 BGE 或 E5 模型）。 |
| **`image_vector`**     | `FLOAT_VECTOR`              | Vector Field | **【图像】向量**：仅对 `image_url` 对应的图像进行编码（例如使用 CLIP 模型的 Vision Encoder）。 |
