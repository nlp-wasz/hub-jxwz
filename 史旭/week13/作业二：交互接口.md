# 交互接口

## 接口类型定义

```python
# 请求和响应体  结构
from datetime import datetime, date
from typing import Union, Annotated, Any, Optional, List, Dict
from pydantic import BaseModel, Field


# 通用 请求体
class PublicRequest(BaseModel):
    """通用请求体"""
    request_id: int = Field(description="通用请求体ID")


class PublicResponse(BaseModel):
    """通用响应体"""
    res_code: int = Field(description="通用响应体CODE")
    res_result: Any = Field(description="通用响应体结果")
    res_mess: str = Field(description="通用响应体信息")
    res_error: str = Field(description="通用响应体错误代码")


# 用户 登录/注册 请求体
class UserLoginRequest(BaseModel):
    """用户登录请求体"""

    user_name: str = Field(description="用户名称")
    user_pass: str = Field(description="用户密码")
    user_role: str = Field(description="用户角色  管理员/普通用户")


# 用户信息 响应体
class UserInfoResponse(BaseModel):
    """用户信息 响应体"""
    user_id: int = Field(description="用户ID")
    user_name: str = Field(description="账号")
    user_password: str = Field(description="密码")
    user_role: str = Field(description="用户角色")
    user_status: bool = Field(description="用户状态")
    created_at: str = Field(description="注册时间")
    updated_at: str = Field(description="更新时间")


# 用户聊天请求体
class ChatRequest(BaseModel):
    """用户聊天请求体"""

    prompt: str = Field(description="请求的问题")
    user_name: str = Field(description="当前登录用户名")
    session_id: str = Field(description="当前聊天记录窗口缓存ID")
    select_tools: List[str] = Field(description="选择使用的MCP工具名称 列表")


# 用户聊天响应体
class ChatResponse(BaseModel):
    """用户聊天响应体"""
    generator: str = Field(description="LLM响应的内容")


# 用户聊天窗口 session 缓存响应体
class ChatSessionResponse(BaseModel):
    """用户聊天窗口 session 缓存响应体"""
    chat_id: int = Field(description="聊天窗口ID")
    session_id: str = Field(description="缓存ID")
    user_id: str = Field(description="用户名称（ID）")
    chat_title: str = Field(description="聊天窗口标题")
    chat_feedback: str = Field(description="用户反馈")
    feedback_at: str = Field(description="反馈时间")
    created_at: str = Field(description="创建时间")
    update_at: str = Field(description="更新时间")


# 用户聊天窗口 message 缓存响应体
class ChatMessageResponse(BaseModel):
    """用户聊天窗口 message 缓存响应体"""
    message_id: int = Field(description="聊天历史ID")
    chat_id: int = Field(description="聊天窗口ID")
    user_id: str = Field(description="用户名称（ID）")
    session_id: str = Field(description="缓存ID")

    message_role: str = Field(description="角色")
    message_content: str = Field(description="内容")
    message_feedback: str = Field(description="反馈")
    feedback_at: str = Field(description="反馈时间")
    created_at: str = Field(description="创建时间")
    update_at: str = Field(description="更新时间")
```



## 接口定义

### 用户信息管理API

```python
# 用户信息管理 API（Router 路由）
import traceback
from fastapi import APIRouter, Query, Form

# from ..model_type.RequestResponse import UserLoginRequest, PublicResponse
# from ..servers import UserServer as userServer

from model_type.RequestResponse import UserLoginRequest, PublicResponse
from servers import UserServer as userServer

userRouter = APIRouter(prefix="/v1/user", tags=["user"])


# 用户登录
@userRouter.post("/user_login")
def user_login(user: UserLoginRequest):
    try:
        if userServer.user_login(user):
            return PublicResponse(res_code=200, res_result=True, res_mess="登录成功", res_error="")
        else:
            return PublicResponse(res_code=500, res_result=False, res_mess="账号或密码输入错误", res_error="")
    except Exception as e:
        return PublicResponse(res_code=500, res_result=False, res_mess="登录失败", res_error=traceback.format_exc())


# 用户注册
@userRouter.post("/user_register")
def user_register(user: UserLoginRequest):
    try:
        if userServer.user_register(user):
            return PublicResponse(res_code=200, res_result=True, res_mess="账号注册成功", res_error="")
        else:
            return PublicResponse(res_code=500, res_result=False, res_mess="账号已存在", res_error="")
    except Exception as e:
        return PublicResponse(res_code=500, res_result=False, res_mess="注册失败", res_error=traceback.format_exc())


# 根据用户名 获取用户信息
@userRouter.get("/byUserNameGetInfo")
def byUserNameGetInfo(user_name: str = Query(..., description="用户名")):
    try:
        if user_name is None:
            return PublicResponse(res_code=500, res_result=False, res_mess="未登录", res_error="")

        is_exists, user_info = userServer.byUserNameGetInfo(user_name)
        if is_exists:
            return PublicResponse(res_code=200, res_result=user_info, res_mess="查询成功", res_error="")
        else:
            return PublicResponse(res_code=500, res_result=user_info, res_mess="查询失败", res_error="")
    except Exception as e:
        return PublicResponse(res_code=500, res_result=False, res_mess="查询失败", res_error=traceback.format_exc())


# 根据用户名 修改用户信息（暂时只修改 用户名和密码）
@userRouter.post("/byUserNameUpdateInfo")
def byUserNameUpdateInfo(
        user_name: str = Form(..., description="用户名"),
        update_user_name: str = Form(..., description="修改后的用户名"),
        user_pass: str = Form(..., description="修改后的密码"),
):
    try:
        if not user_name or not update_user_name or not user_pass:
            return PublicResponse(res_code=500, res_result=False, res_mess="请填写完成信息", res_error="")

        is_update, message = userServer.byUserNameUpdateInfo(user_name, update_user_name, user_pass)
        if is_update:
            return PublicResponse(res_code=200, res_result=message, res_mess="修改成功", res_error="")
        else:
            return PublicResponse(res_code=500, res_result=message, res_mess="修改失败", res_error="")
    except Exception as e:
        return PublicResponse(res_code=500, res_result=False, res_mess="修改失败", res_error=traceback.format_exc())


# 根据用户名 删除用户信息
@userRouter.post("/deleteUserByUserName")
def deleteUserByUserName(user: UserLoginRequest):
    try:
        if not user.user_name:
            return PublicResponse(res_code=500, res_result=False, res_mess="请填写完成信息", res_error="")

        is_update, message = userServer.deleteUserByUserName(user.user_name)
        if is_update:
            return PublicResponse(res_code=200, res_result=message, res_mess="删除成功", res_error="")
        else:
            return PublicResponse(res_code=500, res_result=message, res_mess="删除失败", res_error="")
    except Exception as e:
        return PublicResponse(res_code=500, res_result=False, res_mess="删除失败", res_error=traceback.format_exc())


# 根据用户名的权限 查询权限下的所有用户信息
@userRouter.post("/byRoleGetUserInfo")
def byRoleGetUserInfo(user: UserLoginRequest):
    try:
        if not user.user_name:
            return PublicResponse(res_code=500, res_result=False, res_mess="请填写完成信息", res_error="")

        is_update, user_infos = userServer.byRoleGetUserInfo(user.user_name)
        if is_update:
            return PublicResponse(res_code=200, res_result=user_infos, res_mess="查询成功", res_error="")
        else:
            return PublicResponse(res_code=500, res_result=user_infos, res_mess="查询失败", res_error="")
    except Exception as e:
        return PublicResponse(res_code=500, res_result=False, res_mess="查询失败", res_error=traceback.format_exc())

```



### 聊天信息管理API

```python
# 聊天信息管理 API（Router 路由）
import traceback
from typing import Annotated

from fastapi import APIRouter
from fastapi.responses import StreamingResponse

# from ..model_type.RequestResponse import ChatRequest, ChatResponse, PublicResponse
from model_type.RequestResponse import ChatRequest, ChatResponse, PublicResponse
from servers import ChatServer

chatRouter = APIRouter(prefix="/v1/chat", tags=["chat"])


@chatRouter.post("/")
async def chat(chat_request: ChatRequest) -> StreamingResponse:
    # 调用 server 层异步方法，获取LLM生成结果（这里使用异步函数包裹，也可以直接交给 StreamingResponse）
    async def async_llm_generator():
        async for chunk in ChatServer.chat(chat_request):
            if chunk:
                yield chunk

    # 流式输出
    return StreamingResponse(
        content=async_llm_generator(),  # 异步生成器
        media_type="text/event-stream"  # 流式输出
    )


# 生成 session_id
@chatRouter.get("/generator_session_id")
def generator_session_id():
    try:
        # 调用 chat 服务端
        session_id = ChatServer.generator_session_id()

        return PublicResponse(res_code=200, res_result={"session_id": session_id}, res_mess="", res_error="")
    except Exception as e:
        return PublicResponse(res_code=500, res_result=traceback.format_exc(), res_mess="", res_error="")


# 获取 缓存信息 列表（ChatSessionTable 表）
@chatRouter.get("/get_chat_list")
def get_chat_list(user_name: Annotated[str, "用户名（ID）"]):
    try:
        # 获取 缓存信息 列表（ChatSessionTable 表）
        chat_session = ChatServer.get_chat_list(user_name)

        return PublicResponse(res_code=200, res_result=chat_session, res_mess="", res_error="")
    except Exception as e:
        return PublicResponse(res_code=500, res_result=traceback.format_exc(), res_mess="", res_error="")


# 获取 缓存信息 列表（ChatMessageTable 表）
@chatRouter.get("/get_message_list")
def get_message_list(session_id: Annotated[str, "缓存ID"]):
    try:
        # 获取 缓存信息 列表（ChatSessionTable 表）
        chat_message = ChatServer.get_message_list(session_id)

        return PublicResponse(res_code=200, res_result=chat_message, res_mess="", res_error="")
    except Exception as e:
        return PublicResponse(res_code=500, res_result=traceback.format_exc(), res_mess="", res_error="")


# 根据 session_id 删除缓存信息
@chatRouter.get("/delete_chat_message")
def delete_chat_message(session_id: Annotated[str, "缓存ID"]):
    try:
        # 获取 缓存信息 列表（ChatSessionTable 表）
        is_delete = ChatServer.delete_chat_message(session_id)

        return PublicResponse(res_code=200, res_result=is_delete, res_mess="", res_error="")
    except Exception as e:
        return PublicResponse(res_code=500, res_result=traceback.format_exc(), res_mess="", res_error="")

```



### 股票信息查询 API

```python
# 股票信息查询 API
"""
股票信息查询网站
https://www.autostock.cn/#/trade/stock
https://s.apifox.cn/c3278b4f-5629-4732-858c-36758ff5d083/api-147275957
"""
import uvicorn

TOKEN = "zgaLG8unUPr"

import requests, traceback
from fastapi import FastAPI
from fastapi.openapi.docs import get_swagger_ui_html
from starlette.responses import HTMLResponse
from typing import Union, Annotated, Any, Optional, Dict
from pydantic import BaseModel, Field

stock_api = FastAPI(
    title="StockInfo API",
    description="股票信息查询 API",
    version="1.0.0",
    docs_url=None,
)


# fastapi页面swagger方式默认加载境外资源，这里修改为国内资源
@stock_api.get("/docs", include_in_schema=False)
async def custom_swagger_ui() -> HTMLResponse:
    return get_swagger_ui_html(
        openapi_url="/openapi.json",
        title="API 文档",
        swagger_js_url="https://unpkg.com/swagger-ui-dist@5.9.0/swagger-ui-bundle.js",
        swagger_css_url="https://unpkg.com/swagger-ui-dist@5.9.0/swagger-ui.css",
    )


# path：http服务的路径
# operation_id：mcp服务的名字
# 获取所有股票代码，支持代码和名称模糊查询
@stock_api.get("/get_all_stock_code", operation_id="get_all_stock_code")
async def get_all_stock_code(
        keyword: Annotated[Optional[str], "支持代码和名称模糊查询"] = None
) -> Dict:
    """获取所有股票代码，支持代码和名称模糊查询"""
    url = "https://api.autostock.cn/v1/stock/all" + "?token=" + TOKEN
    if keyword:
        url += "&keyWord=" + keyword

    payload = {}  # type: ignore
    headers = {}  # type: ignore
    try:
        print(F"get_all_stock_code：{url}")
        response = requests.request("GET", url, headers=headers, data=payload, timeout=10)
        return response.json()
    except Exception:
        print(traceback.format_exc())
        return {}


# 获取所有指数，支持代码和名称模糊查询
@stock_api.get("/get_all_index_code", operation_id="get_all_index_code")
async def get_all_index_code():
    """获取所有指数，支持代码和名称模糊查询"""
    url = "https://api.autostock.cn/v1/stock/index/all" + "?token=" + TOKEN
    payload = {}
    headers = {}

    try:
        response = requests.request("GET", url, headers=headers, data=payload, timeout=5)
        return response.json()
    except Exception as e:
        print(traceback.format_exc())
        return {}


# 获取股票板块数据
@stock_api.get("/get_stock_industry_code", operation_id="get_stock_industry_code")
async def get_stock_industry_code():
    """获取股票板块数据"""
    url = "https://api.autostock.cn/v1/stock/industry/rank" + "?token=" + TOKEN
    payload = {}
    headers = {}

    try:
        response = requests.request("GET", url, headers=headers, data=payload, timeout=5)
        return response.json()
    except Exception as e:
        print(traceback.format_exc())
        return {}


# 获取股票大盘数据
@stock_api.get("/get_stock_board_info", operation_id="get_stock_board_info")
async def get_stock_board_info():
    """获取股票大盘数据"""
    url = "https://api.autostock.cn/v1/stock/board" + "?token=" + TOKEN
    payload = {}
    headers = {}

    try:
        response = requests.request("GET", url, headers=headers, data=payload, timeout=5)
        return response.json()
    except Exception as e:
        print(traceback.format_exc())
        return {}


# 股票排行
@stock_api.get("/get_stock_rank", operation_id="get_stock_rank")
async def get_stock_rank(
        node: Annotated[str, "股票市场/板块代码: {'a','b','ash','asz','bsh','bsz'} a(沪深A股)"],
        industryCode: Annotated[Optional[str], "行业代码，可选"] = None,
        pageIndex: Annotated[int, "页码"] = 1,
        pageSize: Annotated[int, "每页大小"] = 100,
        sort: Annotated[
            str, "排序字段: price,priceChange,pricePercent,buy,sell,open,close,high,low,volume,turnover 默认price(交易价格)。"] = "price",
        asc: Annotated[int, "排序方式: 0=降序(默认), 1=升序"] = 0
) -> Dict:
    """股票排行"""
    url = "https://api.autostock.cn/v1/stock/rank" + "?token=" + TOKEN
    headers = {
        'Content-Type': 'application/json'
    }

    try:
        payload = {
            "node": node,
            "industryCode": industryCode,
            "pageIndex": pageIndex,
            "pageSize": pageSize,
            "sort": sort,
            "asc": asc
        }
        response = requests.request("POST", url, headers=headers, json=payload, timeout=5)
        return response.json()
    except Exception as e:
        print(traceback.format_exc())
        return {}


# 月k
@stock_api.get("/get_stock_month_kline", operation_id="get_stock_month_kline")
async def get_stock_month_kline(
        code: Annotated[str, "股票代码"],
        startDate: Annotated[Optional[str], "开始时间(非必填)"] = None,
        endDate: Annotated[Optional[str], "结束时间(非必填)"] = None,
        type: Annotated[int, "0不复权,1前复权,2后复权"] = 0
) -> Dict:
    """月k"""
    url = "https://api.autostock.cn/v1/stock/kline/month" + "?token=" + TOKEN

    headers = {}  # type: ignore
    try:
        payload = {
            "code": code,
            "startDate": startDate,
            "endDate": endDate,
            "type": type
        }
        response = requests.request("GET", url, headers=headers, params=payload, timeout=10)
        return response.json()
    except Exception:
        print(traceback.format_exc())
        return {}


# 周k
@stock_api.get("/get_stock_week_kline", operation_id="get_stock_week_kline")
async def get_stock_week_kline(
        code: Annotated[str, "股票代码"],
        startDate: Annotated[Optional[str], "开始时间(非必填)"] = None,
        endDate: Annotated[Optional[str], "结束时间(非必填)"] = None,
        type: Annotated[int, "0不复权,1前复权,2后复权"] = 0
):
    """周k"""
    url = "https://api.autostock.cn/v1/stock/kline/week" + "?token=" + TOKEN

    headers = {}  # type: ignore
    try:
        payload = {
            "code": code,
            "startDate": startDate,
            "endDate": endDate,
            "type": type
        }
        response = requests.request("GET", url, headers=headers, params=payload, timeout=10)
        return response.json()
    except Exception:
        print(traceback.format_exc())
        return {}


# 日k
@stock_api.get("/get_stock_day_kline", operation_id="get_stock_day_kline")
async def get_stock_day_kline(
        code: Annotated[str, "股票代码"],
        startDate: Annotated[Optional[str], "开始时间(非必填)"] = None,
        endDate: Annotated[Optional[str], "结束时间(非必填)"] = None,
        type: Annotated[int, "0不复权,1前复权,2后复权"] = 0
) -> Dict:
    """日k"""
    url = "https://api.autostock.cn/v1/stock/kline/day" + "?token=" + TOKEN

    headers = {}  # type: ignore
    try:
        payload = {
            "code": code,
            "startDate": startDate,
            "endDate": endDate,
            "type": type
        }
        response = requests.request("GET", url, headers=headers, params=payload, timeout=10)
        return response.json()
    except Exception:
        print(traceback.format_exc())
        return {}


# 股票基础信息
@stock_api.get("/get_stock_info", operation_id="get_stock_info")
async def get_stock_info(code: Annotated[str, "股票代码"]) -> Dict:
    """股票基础信息"""
    url = "https://api.autostock.cn/v1/stock" + "?token=" + TOKEN + "&code=" + code

    payload = {}  # type: ignore
    headers = {}  # type: ignore
    try:
        response = requests.request("GET", url, headers=headers, data=payload, timeout=10)
        return response.json()
    except Exception:
        print(traceback.format_exc())
        return {}


# 分时信息
@stock_api.get("/get_stock_minute_data", operation_id="get_stock_minute_data")
async def get_stock_minute_data(code: str):
    """分时信息"""
    url = "https://api.autostock.cn/v1/stock/min" + "?token=" + TOKEN + "&code=" + code

    payload = {}  # type: ignore
    headers = {}  # type: ignore
    try:
        response = requests.request("GET", url, headers=headers, data=payload, timeout=10)
        return response.json()
    except Exception:
        print(traceback.format_exc())
        return {}


if __name__ == "__main__":
    uvicorn.run(stock_api, host="127.0.0.1", port=8001, workers=1)

```
