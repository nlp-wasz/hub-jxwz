#!/usr/bin/env python3
"""ç²¾ç®€ç‰ˆ MCP æœåŠ¡å™¨"""

import asyncio
from typing import Dict, Any, Annotated
from fastmcp import FastMCP

mcp = FastMCP("Tool Assistant")

# æ–°é—»å·¥å…·
@mcp.tool()
def get_news(category: Annotated[str, "æ–°é—»ç±»åˆ«"]) -> Dict[str, Any]:
    """è·å–æ–°é—»"""
    news = [
        {"title": f"{category}æ–°é—»1", "source": "æ–°é—»æº1"},
        {"title": f"{category}æ–°é—»2", "source": "æ–°é—»æº2"}
    ]
    return {"news": news, "category": category}

@mcp.tool()
def search_news(keyword: Annotated[str, "æœç´¢å…³é”®è¯"]) -> Dict[str, Any]:
    """æœç´¢æ–°é—»"""
    news = [
        {"title": f"{keyword}ç›¸å…³æ–°é—»1", "source": "æœç´¢æº1"},
        {"title": f"{keyword}ç›¸å…³æ–°é—»2", "source": "æœç´¢æº2"}
    ]
    return {"news": news, "keyword": keyword}

# é€šç”¨å·¥å…·
@mcp.tool()
def calculate(expression: Annotated[str, "æ•°å­¦è¡¨è¾¾å¼"]) -> Dict[str, Any]:
    """è®¡ç®—"""
    try:
        result = eval(expression)
        return {"result": result, "expression": expression}
    except:
        return {"error": "è®¡ç®—å¤±è´¥"}

@mcp.tool()
def sentiment_analysis(text: Annotated[str, "åˆ†ææ–‡æœ¬"]) -> Dict[str, Any]:
    """æƒ…æ„Ÿåˆ†æ"""
    if "å¼€å¿ƒ" in text or "å¥½" in text:
        sentiment = "positive"
    elif "ä¼¤å¿ƒ" in text or "å" in text:
        sentiment = "negative"
    else:
        sentiment = "neutral"
    return {"sentiment": sentiment, "text": text}

async def main():
    print("ğŸš€ MCP æœåŠ¡å™¨è¿è¡Œä¸­...")
    await mcp.run(transport="stdio")

if __name__ == "__main__":
    asyncio.run(main())

#!/usr/bin/env python3
"""ç²¾ç®€ç‰ˆ Streamlit ç•Œé¢"""

import streamlit as st
import json
import subprocess
import time

st.set_page_config(page_title="å·¥å…·åŠ©æ‰‹", layout="wide")
st.title("ğŸ”§ æ™ºèƒ½å·¥å…·åŠ©æ‰‹")

class MCPClient:
    def __init__(self):
        self.process = subprocess.Popen(
            ["python", "mcp_server_main.py"],
            stdin=subprocess.PIPE, stdout=subprocess.PIPE,
            stderr=subprocess.PIPE, text=True, bufsize=1
        )
        time.sleep(1)
    
    def call_tool(self, method: str, params: dict) -> dict:
        request = {"jsonrpc": "2.0", "id": 1, "method": method, "params": params}
        self.process.stdin.write(json.dumps(request) + "\n")
        self.process.stdin.flush()
        response = self.process.stdout.readline()
        return json.loads(response)

class ToolFilter:
    def filter_tools(self, user_input: str) -> dict:
        input_lower = user_input.lower()
        
        # æ–°é—»å·¥å…·
        if any(word in input_lower for word in ["æ–°é—»", "èµ„è®¯", "æŠ¥é“"]):
            if "æœç´¢" in input_lower or "æŸ¥æ‰¾" in input_lower:
                return {"tool": "search_news", "type": "news"}
            else:
                return {"tool": "get_news", "type": "news"}
        
        # é€šç”¨å·¥å…·
        elif any(word in input_lower for word in ["è®¡ç®—", "ç®—"]):
            return {"tool": "calculate", "type": "tool"}
        elif any(word in input_lower for word in ["æƒ…æ„Ÿ", "æƒ…ç»ª"]):
            return {"tool": "sentiment_analysis", "type": "tool"}
        
        return {"tool": None, "type": "unknown"}

# åˆå§‹åŒ–
if "client" not in st.session_state:
    st.session_state.client = MCPClient()
if "filter" not in st.session_state:
    st.session_state.filter = ToolFilter()

# ä¾§è¾¹æ 
with st.sidebar:
    st.header("å·¥å…·åˆ—è¡¨")
    st.write("**æ–°é—»å·¥å…·**")
    st.write("- get_news: è·å–æ–°é—»")
    st.write("- search_news: æœç´¢æ–°é—»")
    st.write("**é€šç”¨å·¥å…·**")
    st.write("- calculate: è®¡ç®—")
    st.write("- sentiment_analysis: æƒ…æ„Ÿåˆ†æ")

# ä¸»ç•Œé¢
col1, col2 = st.columns([2, 1])

with col1:
    st.header("å¯¹è¯ç•Œé¢")
    
    user_input = st.text_input("è¾“å…¥æ‚¨çš„éœ€æ±‚:")
    
    if user_input:
        # åˆ†æç”¨æˆ·æ„å›¾
        tool_info = st.session_state.filter.filter_tools(user_input)
        
        st.write(f"**æ£€æµ‹åˆ°çš„å·¥å…·ç±»å‹**: {tool_info['type']}")
        st.write(f"**æ¨èå·¥å…·**: {tool_info['tool']}")
        
        if tool_info["tool"]:
            # æå–å‚æ•°å¹¶è°ƒç”¨å·¥å…·
            if tool_info["tool"] == "get_news":
                category = "ç§‘æŠ€"  # é»˜è®¤ç±»åˆ«
                if "ä½“è‚²" in user_input:
                    category = "ä½“è‚²"
                elif "è´¢ç»" in user_input:
                    category = "è´¢ç»"
                result = st.session_state.client.call_tool("get_news", {"category": category})
            
            elif tool_info["tool"] == "search_news":
                # ç®€å•æå–å…³é”®è¯
                keyword = user_input.replace("æœç´¢", "").replace("æŸ¥æ‰¾", "").strip()
                if not keyword:
                    keyword = "äººå·¥æ™ºèƒ½"  # é»˜è®¤å…³é”®è¯
                result = st.session_state.client.call_tool("search_news", {"keyword": keyword})
            
            elif tool_info["tool"] == "calculate":
                # æå–æ•°å­¦è¡¨è¾¾å¼
                import re
                match = re.search(r'(\d+[\+\-\*\/]\d+)', user_input)
                expression = match.group(1) if match else "2+2"
                result = st.session_state.client.call_tool("calculate", {"expression": expression})
            
            elif tool_info["tool"] == "sentiment_analysis":
                # æå–æ–‡æœ¬
                text = user_input.replace("æƒ…æ„Ÿåˆ†æ", "").replace("æƒ…ç»ªåˆ†æ", "").strip()
                if not text:
                    text = user_input
                result = st.session_state.client.call_tool("sentiment_analysis", {"text": text})
            
            # æ˜¾ç¤ºç»“æœ
            if "result" in result:
                st.success("å·¥å…·è°ƒç”¨æˆåŠŸï¼")
                st.json(result["result"])

with col2:
    st.header("ä½¿ç”¨ç¤ºä¾‹")
    examples = [
        "è·å–æ–°é—»",
        "æœç´¢ç§‘æŠ€æ–°é—»", 
        "è®¡ç®— 10+5*2",
        "åˆ†ææƒ…æ„Ÿï¼šä»Šå¤©å¾ˆå¼€å¿ƒ"
    ]
    
    for example in examples:
        if st.button(example):
            st.session_state.demo_input = example
            st.rerun()

# æ–°é—»å·¥å…·è§¦å‘è¯
["æ–°é—»", "èµ„è®¯", "æŠ¥é“"]

# é€šç”¨å·¥å…·è§¦å‘è¯  
["è®¡ç®—", "ç®—"] â†’ calculate
["æƒ…æ„Ÿ", "æƒ…ç»ª"] â†’ sentiment_analysis

# å®‰è£…ä¾èµ–
pip install fastmcp streamlit

# è¿è¡Œ
python mcp_server_main.py
streamlit run streamlit_demo.py
