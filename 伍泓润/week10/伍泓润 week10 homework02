import requests
import json
import base64
import re
from typing import Dict, List, Optional

class QwenVLTextExtractor:
    def __init__(self, api_key: str, endpoint: str):
        """
        初始化Qwen-VL文本提取器
        
        Args:
            api_key: 阿里云API密钥
            endpoint: 模型服务端点
        """
        self.api_key = api_key
        self.endpoint = endpoint
        self.headers = {
            'Content-Type': 'application/json',
            'Authorization': f'Bearer {api_key}'
        }
    
    def image_to_base64(self, image_path: str) -> str:
        """将图片转换为base64编码"""
        try:
            with open(image_path, 'rb') as image_file:
                encoded_string = base64.b64encode(image_file.read()).decode('utf-8')
            return encoded_string
        except Exception as e:
            raise Exception(f"图片读取失败: {str(e)}")
    
    def extract_text_from_screenshot(self, image_path_or_url: str, 
                                   enhancement: bool = True) -> Dict:
        """
        从带文字的截图中提取文本
        
        Args:
            image_path_or_url: 图片路径或URL
            enhancement: 是否使用增强提示词
            
        Returns:
            extraction_result: 提取结果字典
        """
        
        # 构建提示词
        if enhancement:
            prompt = """请仔细识别这张截图中的所有文字内容，包括：
            1. 界面上的所有可见文本
            2. 按钮文字、菜单项、标签文本
            3. 标题、副标题、正文内容
            4. 数字、符号、特殊字符
            5. 如果有代码，请完整提取代码内容
            
            请按照以下格式返回：
            【文本内容】
            [完整提取的文字]
            
            【文字结构】
            [描述文字的布局结构]
            
            【关键信息】
            [提取重要的关键词和短语]"""
        else:
            prompt = "请提取这张图片中的所有文字内容"
        
        # 构建请求数据
        if image_path_or_url.startswith('http'):
            # 如果是URL
            messages = [
                {
                    "role": "user",
                    "content": [
                        {
                            "image": image_path_or_url
                        },
                        {
                            "text": prompt
                        }
                    ]
                }
            ]
        else:
            # 如果是本地文件
            image_base64 = self.image_to_base64(image_path_or_url)
            messages = [
                {
                    "role": "user",
                    "content": [
                        {
                            "image": f"data:image/jpeg;base64,{image_base64}"
                        },
                        {
                            "text": prompt
                        }
                    ]
                }
            ]
        
        payload = {
            "model": "qwen-vl-plus",  # 根据实际模型名称调整
            "input": {
                "messages": messages
            },
            "parameters": {
                "result_format": "message"
            }
        }
        
        try:
            # 发送请求
            response = requests.post(
                self.endpoint,
                headers=self.headers,
                data=json.dumps(payload),
                timeout=30
            )
            
            if response.status_code == 200:
                result = response.json()
                return self.parse_extraction_result(result)
            else:
                return {
                    "status": "error",
                    "message": f"请求失败，状态码: {response.status_code}",
                    "error": response.text
                }
                
        except requests.exceptions.Timeout:
            return {
                "status": "error",
                "message": "请求超时"
            }
        except Exception as e:
            return {
                "status": "error",
                "message": f"发生错误: {str(e)}"
            }
    
    def parse_extraction_result(self, result: Dict) -> Dict:
        """解析文本提取结果"""
        try:
            # 提取模型返回的文本
            output_text = result['output']['choices'][0]['message']['content']
            
            # 结构化解析结果
            parsed_result = {
                "status": "success",
                "raw_output": output_text,
                "structured_text": self.structure_extracted_text(output_text),
                "cleaned_text": self.clean_extracted_text(output_text)
            }
            
            return parsed_result
            
        except KeyError as e:
            return {
                "status": "error",
                "message": f"解析结果时出错: {str(e)}",
                "raw_response": result
            }
    
    def structure_extracted_text(self, text: str) -> Dict:
        """将提取的文本结构化"""
        structured = {
            "full_text": text,
            "sections": {},
            "keywords": self.extract_keywords(text),
            "contains_code": self.detect_code(text),
            "text_length": len(text)
        }
        
        # 尝试按章节分割
        sections = re.split(r'【(.*?)】', text)
        if len(sections) > 1:
            for i in range(1, len(sections), 2):
                section_name = sections[i]
                section_content = sections[i+1] if i+1 < len(sections) else ""
                structured["sections"][section_name] = section_content.strip()
        
        return structured
    
    def clean_extracted_text(self, text: str) -> str:
        """清理提取的文本"""
        # 移除多余的空白字符
        cleaned = re.sub(r'\s+', ' ', text)
        # 移除可能的多余标点
        cleaned = re.sub(r'[。，；！？]{2,}', '', cleaned)
        return cleaned.strip()
    
    def extract_keywords(self, text: str, top_n: int = 10) -> List[str]:
        """提取关键词（简单实现）"""
        # 移除标点符号
        words = re.findall(r'[\u4e00-\u9fa5a-zA-Z0-9]{2,}', text)
        # 简单的词频统计
        from collections import Counter
        word_freq = Counter(words)
        return [word for word, count in word_freq.most_common(top_n)]
    
    def detect_code(self, text: str) -> bool:
        """检测是否包含代码"""
        code_patterns = [
            r'function\s+\w+',
            r'def\s+\w+',
            r'class\s+\w+',
            r'import\s+\w+',
            r'print\(.*\)',
            r'<\w+>.*</\w+>',
            r'{\s*.*\s*}'
        ]
        for pattern in code_patterns:
            if re.search(pattern, text):
                return True
        return False

# 高级功能类
class AdvancedTextExtractor(QwenVLTextExtractor):
    def __init__(self, api_key: str, endpoint: str):
        super().__init__(api_key, endpoint)
    
    def extract_with_specific_instruction(self, image_path: str, 
                                        instruction: str) -> Dict:
        """使用特定指令提取文本"""
        messages = [
            {
                "role": "user",
                "content": [
                    {
                        "image": f"data:image/jpeg;base64,{self.image_to_base64(image_path)}"
                    },
                    {
                        "text": instruction
                    }
                ]
            }
       
