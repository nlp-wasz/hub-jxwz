# Stock BI Agent - 接口文档

## 项目概述
Stock BI Agent 是一个基于FastAPI的股票分析和数据BI系统，支持用户管理、对话会话、股票收藏、数据管理等功能。

**基础URL**: `http://localhost:8000`

**服务器配置**:
- 主机: `0.0.0.0`
- 端口: `8000`
- 框架: FastAPI

---

## 1. 健康检查接口

### 1.1 健康检查
**请求方法**: `GET`  
**路径**: `/v1/healthy`  
**描述**: 检查服务器是否正常运行

**请求参数**: 无

**响应示例**:
```json
{
  "status": "ok"
}
```

**返回码**:
- `200`: 服务器正常

---

## 2. 用户管理接口

**前缀**: `/v1/users`  
**标签**: `users`

### 2.1 用户登陆
**请求方法**: `POST`  
**路径**: `/v1/users/login`  
**描述**: 用户登陆认证

**请求体**:
```json
{
  "user_name": "string",
  "password": "string"
}
```

**请求参数说明**:
| 字段 | 类型 | 必需 | 描述 |
|------|------|------|------|
| user_name | string | 是 | 用户名 |
| password | string | 是 | 密码 |

**响应示例**:
```json
{
  "code": 200,
  "message": "用户登陆成功",
  "data": []
}
```

**响应说明**:
| 字段 | 类型 | 描述 |
|------|------|------|
| code | int | 状态码 (200 成功, 400 用户名或密码错误, 404 服务器异常) |
| message | string | 返回消息 |
| data | array | 返回数据 |

**返回码**:
- `200`: 登陆成功
- `400`: 用户名或密码错误
- `404`: 服务器异常

---

### 2.2 用户注册
**请求方法**: `POST`  
**路径**: `/v1/users/register`  
**描述**: 新用户注册

**请求体**:
```json
{
  "user_name": "string",
  "password": "string",
  "user_role": "string"
}
```

**请求参数说明**:
| 字段 | 类型 | 必需 | 描述 |
|------|------|------|------|
| user_name | string | 是 | 用户名 |
| password | string | 是 | 密码 |
| user_role | string | 是 | 用户角色 |

**响应示例**:
```json
{
  "code": 200,
  "message": "用户注册成功",
  "data": []
}
```

**返回码**:
- `200`: 注册成功
- `400`: 用户名已存在
- `404`: 服务器异常

---

### 2.3 重置密码
**请求方法**: `POST`  
**路径**: `/v1/users/reset-password`  
**描述**: 用户重置密码

**请求体**:
```json
{
  "user_name": "string",
  "password": "string",
  "new_password": "string"
}
```

**请求参数说明**:
| 字段 | 类型 | 必需 | 描述 |
|------|------|------|------|
| user_name | string | 是 | 用户名 |
| password | string | 是 | 原密码 |
| new_password | string | 是 | 新密码 |

**响应示例**:
```json
{
  "code": 200,
  "message": "密码重置成功",
  "data": []
}
```

**返回码**:
- `200`: 密码重置成功/失败
- `400`: 用户名或密码错误
- `404`: 服务器异常

---

### 2.4 获取用户信息
**请求方法**: `POST`  
**路径**: `/v1/users/info`  
**描述**: 获取指定用户的信息

**请求参数**:
| 字段 | 类型 | 必需 | 描述 | 位置 |
|------|------|------|------|------|
| user_name | string | 是 | 用户名 | Query |

**响应示例**:
```json
{
  "code": 200,
  "message": "获取用户信息成功",
  "data": {
    "user_id": 1,
    "user_name": "testuser",
    "user_role": "analyst",
    "register_time": "2024-01-15T10:30:00",
    "status": true
  }
}
```

**数据模型 - User**:
| 字段 | 类型 | 描述 |
|------|------|------|
| user_id | int | 用户ID |
| user_name | string | 用户名 |
| user_role | string | 用户角色 |
| register_time | datetime | 注册时间 |
| status | boolean | 用户状态（true 激活, false 禁用） |

**返回码**:
- `200`: 获取成功
- `400`: 用户不存在
- `404`: 服务器异常

---

### 2.5 修改用户信息
**请求方法**: `POST`  
**路径**: `/v1/users/reset-info`  
**描述**: 修改用户信息（角色、状态）

**请求体**:
```json
{
  "user_name": "string",
  "user_role": "string (optional)",
  "status": "boolean (optional)"
}
```

**请求参数说明**:
| 字段 | 类型 | 必需 | 描述 |
|------|------|------|------|
| user_name | string | 是 | 用户名 |
| user_role | string | 否 | 新的用户角色 |
| status | boolean | 否 | 新的用户状态 |

**响应示例**:
```json
{
  "code": 200,
  "message": "用户信息修改成功",
  "data": []
}
```

**返回码**:
- `200`: 修改成功
- `400`: 用户不存在
- `404`: 服务器异常

---

### 2.6 删除用户
**请求方法**: `POST`  
**路径**: `/v1/users/delete`  
**描述**: 删除指定用户

**请求参数**:
| 字段 | 类型 | 必需 | 描述 | 位置 |
|------|------|------|------|------|
| user_name | string | 是 | 用户名 | Query |

**响应示例**:
```json
{
  "code": 200,
  "message": "用户删除成功",
  "data": []
}
```

**返回码**:
- `200`: 删除成功
- `400`: 用户不存在
- `404`: 服务器异常

---

### 2.7 用户列表
**请求方法**: `POST`  
**路径**: `/v1/users/list`  
**描述**: 获取所有用户列表

**请求参数**: 无

**响应示例**:
```json
{
  "code": 200,
  "message": "ok",
  "data": [
    {
      "user_id": 1,
      "user_name": "admin",
      "user_role": "admin",
      "register_time": "2024-01-01T08:00:00",
      "status": true
    },
    {
      "user_id": 2,
      "user_name": "testuser",
      "user_role": "analyst",
      "register_time": "2024-01-15T10:30:00",
      "status": true
    }
  ]
}
```

**返回码**:
- `200`: 获取成功
- `404`: 服务器异常

---

## 3. 对话接口

**前缀**: `/v1/chat`  
**标签**: `chat`

### 3.1 创建对话流
**请求方法**: `POST`  
**路径**: `/v1/chat/`  
**描述**: 创建新对话并获取流式响应

**请求体**:
```json
{
  "content": "string",
  "user_name": "string",
  "session_id": "string (optional)",
  "task": "string (optional)",
  "tools": ["string"] (optional),
  "image_content": "string (optional)",
  "file_content": "string (optional)",
  "url_content": "string (optional)",
  "audio_content": "string (optional)",
  "video_content": "string (optional)",
  "vison_mode": "boolean (optional, default: false)",
  "deepsearch_mode": "boolean (optional, default: false)",
  "sql_interpreter": "boolean (optional, default: false)",
  "code_interpreter": "boolean (optional, default: false)"
}
```

**请求参数说明**:
| 字段 | 类型 | 必需 | 描述 |
|------|------|------|------|
| content | string | 是 | 用户的提问内容 |
| user_name | string | 是 | 用户名 |
| session_id | string | 否 | 对话session_id，用于获取对话上下文 |
| task | string | 否 | 对话任务类型 (如 "股票分析", "数据BI") |
| tools | array | 否 | 可选的工具列表 |
| image_content | string | 否 | 图片内容 |
| file_content | string | 否 | 文件内容 |
| url_content | string | 否 | URL内容 |
| audio_content | string | 否 | 音频内容 |
| video_content | string | 否 | 视频内容 |
| vison_mode | boolean | 否 | 是否启用视觉模式（默认: false） |
| deepsearch_mode | boolean | 否 | 是否启用深度搜索模式（默认: false） |
| sql_interpreter | boolean | 否 | 是否启用SQL解释器（默认: false） |
| code_interpreter | boolean | 否 | 是否启用代码解释器（默认: false） |

**响应类型**: `text/event-stream` (Server-Sent Events)  
**流式响应示例**:
```
data: {"response_text": "我是小呆闲聊助手。\n\n"}
data: {"response_text": "让我为您分析这支股票..."}
```

**返回码**:
- `200`: 流式连接成功
- `500`: 服务器异常

---

### 3.2 初始化对话
**请求方法**: `POST`  
**路径**: `/v1/chat/init`  
**描述**: 初始化新的对话会话，生成session_id

**请求参数**: 无

**响应示例**:
```json
{
  "code": 200,
  "message": "ok",
  "data": {
    "session_id": "abc123def456"
  }
}
```

**返回码**:
- `200`: 初始化成功
- `500`: 服务器异常

---

### 3.3 获取对话内容
**请求方法**: `POST`  
**路径**: `/v1/chat/get`  
**描述**: 获取指定session的对话内容

**请求参数**:
| 字段 | 类型 | 必需 | 描述 | 位置 |
|------|------|------|------|------|
| session_id | string | 是 | 对话session_id | Query |

**响应示例**:
```json
{
  "code": 200,
  "message": "ok",
  "data": [
    {
      "role": "user",
      "content": "帮我分析一下腾讯的股票"
    },
    {
      "role": "assistant",
      "content": "好的，让我为您分析..."
    }
  ]
}
```

**返回码**:
- `200`: 获取成功
- `500`: 服务器异常

---

### 3.4 删除对话
**请求方法**: `POST`  
**路径**: `/v1/chat/delete`  
**描述**: 删除指定的对话会话

**请求参数**:
| 字段 | 类型 | 必需 | 描述 | 位置 |
|------|------|------|------|------|
| session_id | string | 是 | 对话session_id | Query |

**响应示例**:
```json
{
  "code": 200,
  "message": "ok",
  "data": []
}
```

**返回码**:
- `200`: 删除成功
- `500`: 服务器异常

---

### 3.5 获取用户对话列表
**请求方法**: `POST`  
**路径**: `/v1/chat/list`  
**描述**: 获取指定用户的所有对话列表

**请求参数**:
| 字段 | 类型 | 必需 | 描述 | 位置 |
|------|------|------|------|------|
| user_name | string | 是 | 用户名 | Query |

**响应示例**:
```json
{
  "code": 200,
  "message": "ok",
  "data": [
    {
      "user_id": 1,
      "session_id": "abc123def456",
      "title": "分析腾讯股票",
      "start_time": "2024-01-15T10:30:00",
      "feedback": null,
      "feedback_time": null
    }
  ]
}
```

**数据模型 - ChatSession**:
| 字段 | 类型 | 描述 |
|------|------|------|
| user_id | int | 用户ID |
| session_id | string | 对话session_id |
| title | string | 对话标题 |
| start_time | datetime | 对话开始时间 |
| feedback | boolean | 用户反馈 (null 未反馈, true 正向, false 负向) |
| feedback_time | datetime | 反馈时间 |

**返回码**:
- `200`: 获取成功
- `500`: 服务器异常

---

### 3.6 对话反馈
**请求方法**: `POST`  
**路径**: `/v1/chat/feedback`  
**描述**: 对对话中的某条消息进行反馈（点赞/点踩）

**请求参数**:
| 字段 | 类型 | 必需 | 描述 | 位置 |
|------|------|------|------|------|
| session_id | string | 是 | 对话session_id | Query |
| message_id | int | 是 | 消息ID | Query |
| feedback | boolean | 是 | 反馈结果 (true 正向反馈, false 负向反馈) | Query |

**响应示例**:
```json
{
  "code": 200,
  "message": "ok",
  "data": []
}
```

**返回码**:
- `200`: 反馈记录成功
- `500`: 服务器异常

---

## 4. 股票管理接口

**前缀**: `/v1/stock`  
**标签**: `stocks`

### 4.1 获取用户收藏股票列表
**请求方法**: `POST`  
**路径**: `/v1/stock/list_fav_stock`  
**描述**: 获取指定用户收藏的所有股票

**请求参数**:
| 字段 | 类型 | 必需 | 描述 | 位置 |
|------|------|------|------|------|
| user_name | string | 是 | 用户名 | Query |

**响应示例**:
```json
{
  "code": 200,
  "message": "获取用户所有股票成功",
  "data": [
    {
      "stock_code": "0700.HK",
      "create_time": "2024-01-10T15:30:00"
    },
    {
      "stock_code": "AAPL",
      "create_time": "2024-01-12T09:15:00"
    }
  ]
}
```

**数据模型 - StockFavInfo**:
| 字段 | 类型 | 描述 |
|------|------|------|
| stock_code | string | 股票代码 |
| create_time | datetime | 收藏时间 |

**返回码**:
- `200`: 获取成功
- `404`: 服务器异常

---

### 4.2 添加收藏股票
**请求方法**: `POST`  
**路径**: `/v1/stock/add_fav_stock`  
**描述**: 将指定股票添加到用户的收藏列表

**请求参数**:
| 字段 | 类型 | 必需 | 描述 | 位置 |
|------|------|------|------|------|
| user_name | string | 是 | 用户名 | Query |
| stock_code | string | 是 | 股票代码 | Query |

**响应示例**:
```json
{
  "code": 200,
  "message": "添加成功",
  "data": []
}
```

**返回码**:
- `200`: 添加成功
- `404`: 服务器异常

---

### 4.3 删除收藏股票
**请求方法**: `POST`  
**路径**: `/v1/stock/del_fav_stock`  
**描述**: 从用户的收藏列表中删除指定股票

**请求参数**:
| 字段 | 类型 | 必需 | 描述 | 位置 |
|------|------|------|------|------|
| user_name | string | 是 | 用户名 | Query |
| stock_code | string | 是 | 股票代码 | Query |

**响应示例**:
```json
{
  "code": 200,
  "message": "删除成功",
  "data": []
}
```

**返回码**:
- `200`: 删除成功
- `404`: 服务器异常

---

### 4.4 清空用户收藏
**请求方法**: `POST`  
**路径**: `/v1/stock/clear_fav_stock`  
**描述**: 清空用户的所有收藏股票

**请求参数**:
| 字段 | 类型 | 必需 | 描述 | 位置 |
|------|------|------|------|------|
| user_name | string | 是 | 用户名 | Query |

**响应示例**:
```json
{
  "code": 200,
  "message": "删除成功",
  "data": []
}
```

**返回码**:
- `200`: 清空成功
- `404`: 服务器异常

---

## 5. 数据管理接口

**前缀**: `/v1/data`  
**标签**: `data`

> **注意**: 以下接口目前为占位符实现，未包含具体的业务逻辑。

### 5.1 下载数据
**请求方法**: `POST`  
**路径**: `/v1/data/download`  
**描述**: 下载数据文件

**请求参数**: 待实现

**响应**: 待实现

---

### 5.2 创建数据
**请求方法**: `POST`  
**路径**: `/v1/data/create`  
**描述**: 创建新的数据记录

**请求参数**: 待实现

**响应**: 待实现

---

### 5.3 上传数据
**请求方法**: `POST`  
**路径**: `/v1/data/upload`  
**描述**: 上传数据文件

**请求参数**: 待实现

**响应**: 待实现

---

### 5.4 删除数据
**请求方法**: `POST`  
**路径**: `/v1/data/delete`  
**描述**: 删除数据记录

**请求参数**: 待实现

**响应**: 待实现

---

## 6. Stock 底层API接口

**路径前缀**: `/stock`  
**描述**: 这是一个独立的FastAPI应用（来自 `api.autostock`），挂载在主应用下

**使用方式**: 所有 `/stock` 路径下的请求都会被转发到 `autostock` 应用处理

---

## 7. 通用响应模型

### BasicResponse
所有接口的标准响应格式：

```python
{
  "code": int,              # HTTP状态码
  "message": string,        # 返回信息
  "data": array | object   # 返回数据，可以是数组或对象
}
```

**状态码说明**:
| 状态码 | 描述 |
|--------|------|
| 200 | 请求成功 |
| 400 | 请求参数错误或业务逻辑错误 |
| 404 | 服务器异常 |
| 500 | 服务器异常 |

---

## 8. 错误处理

所有接口在发生异常时，将返回如下格式的错误信息：

```json
{
  "code": 404,
  "message": "详细的错误堆栈信息",
  "data": []
}
```

---

## 9. 数据模型总结

### User
```python
{
  "user_id": int,
  "user_name": str,
  "user_role": str,
  "register_time": datetime,
  "status": bool
}
```

### ChatSession
```python
{
  "user_id": int,
  "session_id": str,
  "title": str,
  "start_time": datetime,
  "feedback": bool | null,
  "feedback_time": datetime | null
}
```

### StockFavInfo
```python
{
  "stock_code": str,
  "create_time": datetime
}
```

### BasicResponse
```python
{
  "code": int,
  "message": str,
  "data": list | dict | null
}
```

---

## 10. 认证和授权

> **当前版本**: 接口不需要额外的认证令牌，用户通过 `user_name` 参数进行标识。
>
> **建议**: 生产环境应实现 Token（JWT）认证机制。

---

## 11. 速率限制

> **当前版本**: 没有实现速率限制。

---

## 12. 快速开始

### 启动服务器
```bash
cd d:\learning\八斗\Week13\06-stock-bi-agent
python main_server.py
```

### 健康检查
```bash
curl http://localhost:8000/v1/healthy
```

### 用户注册示例
```bash
curl -X POST http://localhost:8000/v1/users/register \
  -H "Content-Type: application/json" \
  -d '{
    "user_name": "testuser",
    "password": "password123",
    "user_role": "analyst"
  }'
```

### 用户登陆示例
```bash
curl -X POST http://localhost:8000/v1/users/login \
  -H "Content-Type: application/json" \
  -d '{
    "user_name": "testuser",
    "password": "password123"
  }'
```

### 初始化对话示例
```bash
curl -X POST http://localhost:8000/v1/chat/init
```

### 创建对话流示例
```bash
curl -X POST http://localhost:8000/v1/chat/ \
  -H "Content-Type: application/json" \
  -d '{
    "content": "帮我分析一下腾讯的股票",
    "user_name": "testuser",
    "task": "股票分析"
  }'
```

---

## 附录：API接口汇总表

| 接口 | 方法 | 路径 | 描述 |
|------|------|------|------|
| 健康检查 | GET | `/v1/healthy` | 检查服务器状态 |
| 用户登陆 | POST | `/v1/users/login` | 用户认证登陆 |
| 用户注册 | POST | `/v1/users/register` | 注册新用户 |
| 重置密码 | POST | `/v1/users/reset-password` | 修改用户密码 |
| 获取用户信息 | POST | `/v1/users/info` | 获取用户详细信息 |
| 修改用户信息 | POST | `/v1/users/reset-info` | 修改用户信息 |
| 删除用户 | POST | `/v1/users/delete` | 删除用户账户 |
| 用户列表 | POST | `/v1/users/list` | 获取所有用户 |
| 创建对话 | POST | `/v1/chat/` | 创建新对话（流式） |
| 初始化对话 | POST | `/v1/chat/init` | 生成session_id |
| 获取对话内容 | POST | `/v1/chat/get` | 获取对话历史 |
| 删除对话 | POST | `/v1/chat/delete` | 删除对话会话 |
| 对话列表 | POST | `/v1/chat/list` | 获取用户对话列表 |
| 对话反馈 | POST | `/v1/chat/feedback` | 反馈对话内容 |
| 获取收藏股票 | POST | `/v1/stock/list_fav_stock` | 获取用户收藏的股票 |
| 添加收藏股票 | POST | `/v1/stock/add_fav_stock` | 添加股票到收藏 |
| 删除收藏股票 | POST | `/v1/stock/del_fav_stock` | 从收藏中删除股票 |
| 清空收藏 | POST | `/v1/stock/clear_fav_stock` | 清空所有收藏 |
| 下载数据 | POST | `/v1/data/download` | 下载数据文件 |
| 创建数据 | POST | `/v1/data/create` | 创建数据记录 |
| 上传数据 | POST | `/v1/data/upload` | 上传数据文件 |
| 删除数据 | POST | `/v1/data/delete` | 删除数据记录 |

---

**文档版本**: 1.0  
**最后更新**: 2025年11月26日  
**维护者**: Stock BI Agent 项目组
