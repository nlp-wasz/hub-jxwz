
# 作业1
## 接口设计文档

### 1、数据管理接口

#### 1.1 上传附件

- > POST /manage/upload_files

---

- 入参

```
  {  
    'files':[doc1,doc2],
    'tags':''，  
    'chunk_size':'1024',
    'chunk_overlap':'100',
  }
```

| 参数名           | 类型      | 必填 | 描述           |
|:--------------|:--------|:---|:-------------|
| files         | file[]  | 是  | 上传的文件        |
| tags	         | string  | 否  | 标签，多个用英文逗号隔开 |
| chunk_size    | integer | 否  | 分块大小，默认512   |
| chunk_overlap | integer | 否  | 分块重叠大小，默认50  |

---

- 出参

```    
{
  'results':[
    {
      'document_id': 'doc_123',
      'filename': 'doc1.pdf',
      'status': 'success',
      'message': '上传成功'
    },
    {
      'document_id': 'doc_124',
      'filename': 'doc2.docx',
      'status': 'success',
      'message': '上传成功'
    }
  ]
}
```

| 参数名                  | 类型      | 描述     |
|:---------------------|:--------|:-------|
| results              | array   | 上传的文件  |
| results.document_id	 | string  | 上传附件id |
| results.filename     | integer | 上传附件名称 |
| results.status       | integer | 附件上传状态 |
| results.message      | integer | 返回信息   |

---

#### 1.2 修改附件

- > POST /manage/update_file

---

- 入参

```
  {  
    'file':doc1,
    'document_id':'doc_124'，
     'update_chunks': [
        {
            'chunk_id': 'chunk_001',
            'content': '更新后的内容',
            'metadata': {
                'page': 1,
                'section': '2.1'
            }
        }
    ],     
    'tags':''
  }
```

| 参数名           | 类型     | 必填 | 描述         |
|:--------------|:-------|:---|:-----------|
| file          | file   | 是  | 上传的文件      |
| document_id	  | string | 是  | 需要修改的附件id  |
| update_chunks | array  | 否  | 需要更新的chunk |
| tags          | string | 否  | 更新后的标签     |

---

- 出参

```
  {
    'results':[
      {
        'document_id': 'doc_123',
        'filename': 'doc1.pdf',
        'status': 'success',
        'message': '上传成功'
      }
    ]
  }
```

| 参数名           | 类型      | 描述           |
|:--------------|:--------|:-------------|
| results       | array   | 上传的文件        |
| tags	         | string  | 标签，多个用英文逗号隔开 |
| chunk_size    | integer | 分块大小，默认512   |
| chunk_overlap | integer | 分块重叠大小，默认50  |

---

#### 1.3 删除附件

- > POST /manage/delete_files

---

- 入参

```
  {  
    'document_ids':['doc_123','doc_124']，
  }
```

| 参数名           | 类型    | 必填 | 描述        |
|:--------------|:------|:---|:----------|
| document_ids	 | array | 是  | 需要删除的附件id |

---

- 出参

```
  {
    "results": [
        {
            "document_id": "doc_123",
            "status": "success",
            "message": "删除成功"
        },
        {
            "document_id": "doc_124",
            "status": "success",
            "message": "删除成功"
        }
    ],
    "deleted_count": 2
}
```

| 参数名            | 类型      | 描述     |
|:---------------|:--------|:-------|
| results        | array   | 删除结果列表 |
| deleted_count	 | integer | 删除数量   |

---

#### 1.4 查询附件

- > POST /manage/query_files

---

- 入参

```
  {
    "document_ids": ["doc_123"],
    "tags": "important",
    "filename": "report",
    "page": 1,
    "page_size": 20
  }
```

| 参数名           | 类型      | 必填 | 描述        |
|:--------------|:--------|:---|:----------|
| document_ids	 | array   | 否  | 需要查询的附件id |
| tags	         | string  | 否  | 查询标签      |
| filename	     | string  | 否  | 文件名称      |
| page	         | integer | 否  | 页码，默认1    |
| page_size	    | integer | 否  | 每页条数，默认20 |

---

- 出参

```
  {
    "results": [
        {
            "document_id": "doc_123",
            "filename": "report.pdf",
            "file_size": 1024000,
            "upload_time": "2024-01-15T10:30:00Z",
            "tags": ["important", "report"],
            "chunk_count": 45,
            "status": "processed"
        }
    ],
    "total_count": 1,
    "page": 1,
    "page_size": 20
  }
```

| 参数名          | 类型      | 描述     |
|:-------------|:--------|:-------|
| results      | array   | 返回附件列表 |
| total_count	 | integer | 数据总条数  |
| page	        | integer | 页码     |
| page_size	   | integer | 每页大小   |

---

#### 1.5 查询文档分块

- > POST /manage/query_file_chunks

---

- 入参

```
  {
    "document_ids": ["doc_123"],
    "chunk_ids": ["chunk_001", "chunk_002"],
    "page": 1,
    "page_size": 50
  }
```

| 参数名           | 类型      | 必填 | 描述         |
|:--------------|:--------|:---|:-----------|
| document_ids	 | array   | 是  | 需要查询的附件id  |
| chunk_ids	    | array   | 否  | 查询chunk的id |
| page	         | integer | 否  | 页码，默认1     |
| page_size	    | integer | 否  | 每页条数，默认50  |

---

- 出参

```
  {
    "results": [
        {
            "chunk_id": "chunk_001",
            "document_id": "doc_123",
            "content": "分块内容文本...",
            "metadata": {
                "page": 1,
                "section": "1.1",
                "start_index": 0,
                "end_index": 512
            },
            "embedding_status": "success"
        }
    ],
    "total_count": 45,
    "page": 1,
    "page_size": 50
}
```

| 参数名          | 类型      | 描述     |
|:-------------|:--------|:-------|
| results      | array   | 返回附件列表 |
| total_count	 | integer | 数据总条数  |
| page	        | integer | 页码     |
| page_size	   | integer | 每页大小   |

---

### 2、多模态检索接口

#### 2.1 多模态检索

- > POST /retrieve/cross_modal

---

- 入参

```
  {
    "source_modality": "image",
    "target_modality": "text",
    "query_data": "base64_encoded_image_data",
    "cross_modal_strategy": "embedding_similarity",
    "filters": {
        "modalities": ["text", "audio"]
    },
    "top_k": 5
}
```

| 参数名              | 类型      | 必填 | 描述                          |
|:-----------------|:--------|:---|:----------------------------|
| source_modality	 | string  | 是  | 源模态：text/image/audio/video  |
| target_modality	 | string  | 是  | 目标模态：text/image/audio/video |
| query_data	      | string  | 是  | 查询数据                        |
| filters	         | object  | 否  | 过滤条件                        |
| top_k	           | integer | 否  | 返回结果数，默认3                   |

---

- 出参

```
  {
    "results": [
        {
            "chunk_id": "chunk_003",
            "document_id": "doc_125",
            "filename": "description.txt",
            "content": "这张图片展示了一个红色的汽车...",
            "source_modality": "image",
            "target_modality": "text",
            "cross_modal_score": 0.82,
            "metadata": {
                "translation_confidence": 0.75
            }
        }
    ]
  }
```

| 参数名     | 类型    | 描述       |
|:--------|:------|:---------|
| results | array | 返回的chunk |

---

### 3、多模态问答接口

#### 3.1 流式多模态问答

- > POST /qa/multi_modal

---

- 入参

```
  {
    "question": "请详细描述这张图片中的场景",
    "image_data": "base64_encoded_image",
    "stream": true,
    "chunk_size": 100
  }
```

| 参数名         | 类型      | 必填 | 描述     |
|:------------|:--------|:---|:-------|
| question	   | string  | 是  | 用户问题   |
| image_data	 | string  | 是  | 图片数据   |
| stream	     | bool    | 是  | 是否流式输出 |
| chunk_size	 | integer | 否  | 流式块大小  |

---

- 出参

```
  {"type": "start", "timestamp": "2024-01-15T10:30:00Z"}

{"type": "reasoning", "step": "视觉分析", "progress": 0.3}

{"type": "content", "text": "这张图片展示了一个", "chunk_id": 1}

{"type": "content", "text": "现代化的办公环境", "chunk_id": 2}

{"type": "evidence", "modality": "image", "bbox": "x1,y1,x2,y2", "object": "办公桌"}

{"type": "content", "text": "，包括一张办公桌和电脑", "chunk_id": 3}

{"type": "complete", "final_answer": "这张图片展示了一个现代化的办公环境...", "total_chunks": 15}
```

| 参数名     | 类型    | 描述       |
|:--------|:------|:---------|
| results | array | 返回的chunk |

---
# 作业2
## 对多模态RAG的项目，如果用户使用【文本】提问 vs 【文本 + 图】提问，你会怎么处理？有什么区别？

- 纯文本提问：1. 文本理解 → 2. 文本检索 → 3. 文本推理 → 4. 文本生成
- 文字+图片提问：1.识别图片 → 2. 文本关联 → 3. 结合两者信息推理 → 4. 文本生成
- 区别：
  - 纯文本推理更快，消耗资源更少；
  - 文字+图推理速度慢一些，消耗资源更多，需要结合视觉模型。


# 作业3
## 数据结构设计方案

#### chunk表

| 字段名               | 类型     | 说明      | 
|-------------------|--------|---------|
| id                | String | 唯一标识符   | 
| knowledge_base_id | String | 所属知识库ID | 
| document_id       | String | 所属文档ID  | 

#### 文本类型

| 字段名              | 类型          | 说明      |
|------------------|-------------|---------|
| id               | String      | 唯一标识符   |
| text_content     | String      | 文本内容    |
| bge_vector       | FloatVector | 编码的文本向量 |
| clip_text_vector | FloatVector | 文本编码向量  |
| metadata         | JSON        | 文本元数据   |

#### 图像类型

| 字段名               | 类型          | 说明       |
|-------------------|-------------|----------|
| id                | String      | 唯一标识符    |
| image_path        | String      | 图像存储路径   |
| image_caption     | String      | 图像描述文本   |
| clip_image_vector | FloatVector | 图像编码向量   |
| ocr_text          | String      | OCR提取的文本 |
| metadata          | JSON        | 图像元数据    |

#### 表格类型

| 字段名        | 类型          | 说明     |
|------------|-------------|--------|
| id         | String      | 唯一标识符  |
| table_text | String      | 表格文本内容 |
| bge_vector | FloatVector | 表格文本向量 |

#### 关联表

| 字段名            | 类型          | 说明        |
|----------------|-------------|-----------|
| chunk_id       | String      | chunk主键   |
| business_key   | String      | 文本、图、表主键  |
| business_table | FloatVector | 属于表文本、图、表 |


