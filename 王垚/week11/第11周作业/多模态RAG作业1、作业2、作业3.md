# 多模态 RAG 作业落地文档

---

## 作业一：接口规范

### 数据管理

#### 创建数据集

| 项 | 值 |
| --- | --- |
| 方法 | POST |
| 路径 | `/datasets` |
| 认证 | 必需 |
| Content-Type | application/json |

- 请求体字段

| 字段 | 类型 | 必填 | 说明 | 示例 |
| --- | --- | --- | --- | --- |
| name | string | 是 | 数据集名称 | "gov-knowledge" |
| description | string | 否 | 描述 | "政府公开数据" |
| modalities | string[] | 是 | `text/image/table` | ["text","image","table"] |
| embedding | object | 是 | 模型与维度配置 | 见下 |
| index | object | 是 | 各模态索引配置 | 见下 |

- `embedding` 示例

```json
{
  "text_model": "bge-m3",
  "image_model": "openclip-vit-l-14",
  "table_model": "tapas-base",
  "dim": { "text": 1024, "image": 768, "table": 512 }
}
```

- `index` 示例

```json
{
  "text": { "type": "HNSW", "metric": "IP", "params": { "M": 32, "efConstruction": 200 } },
  "image": { "type": "IVF_PQ", "metric": "IP", "params": { "nlist": 4096, "m": 32 } },
  "table": { "type": "HNSW", "metric": "IP", "params": { "M": 32, "efConstruction": 200 } }
}
```

- 成功返回

```json
{ "code": 0, "message": "ok", "data": { "dataset_id": "ds_xxx" }, "request_id": "..." }
```

---

#### 文档入库（批量，支持文本/图片/表格）

| 项 | 值 |
| --- | --- |
| 方法 | POST |
| 路径 | `/datasets/{dataset_id}/documents` |
| 认证 | 必需 |
| Content-Type | application/json 或 multipart/form-data |

- 请求体字段（JSON 场景）

| 字段 | 类型 | 必填 | 说明 |
| --- | --- | --- | --- |
| documents | array | 是 | 文档数组（见下元素结构） |
| chunking | object | 否 | 文本分块策略 `{ by: "token", size: 512, overlap: 64 }` |

- `documents[]` 元素（按模态差异化字段）

| 字段 | 类型 | 必填 | 适用模态 | 说明 |
| --- | --- | --- | --- | --- |
| modality | string | 是 | 全部 | `text`/`image`/`table` |
| content_text | string | 文本需 | text | 文本内容（或解析后文本） |
| content_url | string | 图/表需 | image/table | 远程URL（或改用 multipart 文件） |
| preprocess | object | 否 | image | `{ ocr: true, caption: true }` |
| table_read | object | 否 | table | `{ sheet: "2024", header_row: 1 }` |
| metadata | object | 否 | 全部 | `{ page, dept, date, lang, ... }` |

- 成功返回

```json
{
  "code": 0,
  "message": "ok",
  "data": {
    "doc_stats": [
      { "doc_id": "doc_t_001", "modality": "text", "chunk_count": 14, "vector_count": 14 },
      { "doc_id": "doc_i_002", "modality": "image", "chunk_count": 1, "vector_count": 1 },
      { "doc_id": "doc_tb_003", "modality": "table", "chunk_count": 6, "vector_count": 6 }
    ]
  },
  "request_id": "..."
}
```

- 相关接口

| 功能 | 方法 | 路径 | 说明 |
| --- | --- | --- | --- |
| 文档列表 | GET | `/datasets/{dataset_id}/documents?modality=text&limit=50&cursor=...` | 支持分页与按模态过滤 |
| 删除文档 | DELETE | `/documents/{doc_id}` | 逻辑或物理删除（与 RDBMS 一致） |
| 重建索引 | POST | `/datasets/{dataset_id}/reindex` | 批量重建索引（控制台谨慎调用） |
| 数据统计 | GET | `/datasets/{dataset_id}/stats` | 返回总文档与各模态向量数 |

---

### 多模态检索

| 项 | 值 |
| --- | --- |
| 方法 | POST |
| 路径 | `/retrieve` |
| 认证 | 必需 |
| Content-Type | application/json |

- 请求体字段

| 字段 | 类型 | 必填 | 说明 | 示例 |
| --- | --- | --- | --- | --- |
| dataset_id | string | 是 | 检索的数据集 | ds_xxx |
| query | object | 是 | 用户查询 | `{ text:"..", images:[{url:".."}] }` |
| top_k | int | 否 | 召回数量 | 20 |
| filters | object | 否 | 元数据过滤 | `{ metadata: { dept:["财政部"], date_gte:"2023-01-01" } }` |
| weights | object | 否 | 模态融合权重 | `{ text:0.6, image:0.4, table:0.6 }` |
| hybrid | object | 否 | 稀疏检索融合 | `{ bm25:true, bm25_weight:0.2 }` |
| rerank | object | 否 | 重排 | `{ enabled:true, model:"bge-reranker-m3", top_k:10 }` |
| return | object | 否 | 扩展返回 | `{ with_snippet:true, with_bbox:true, with_table_ranges:true }` |

- 成功返回（关键字段）

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| hits[] | array | 命中文档块（含各模态） |
| hits[].doc_id | string | 文档ID |
| hits[].chunk_id | string | 文档块ID |
| hits[].modality | string | `text`/`image`/`table` |
| hits[].score | float | 相似度分数（融合后） |
| hits[].snippet | string | 片段/描述 |
| hits[].bbox | number[4] | 图像归一化区域（可选） |
| hits[].table_range | object | 表格范围 `{ sheet, rows, cols }` |
| hits[].metadata | object | 元信息 |

---

### 多模态问答

| 项 | 值 |
| --- | --- |
| 方法 | POST |
| 路径 | `/qa` |
| 认证 | 必需 |
| Content-Type | application/json |

- 请求体字段

| 字段 | 类型 | 必填 | 说明 |
| --- | --- | --- | --- |
| dataset_id | string | 是 | 目标数据集 |
| query | object | 是 | `{ text, images[] }`；可仅文本或文本+图 |
| retrieval | object | 否 | `{ top_k, rerank_top_k, use_table_reader, use_ocr_caption }` |
| generation | object | 否 | `{ model, max_tokens, temperature, lang }` |
| conversation | object | 否 | `{ conversation_id, history[] }` |
| stream | boolean | 否 | 是否流式返回 |
| return | object | 否 | `{ with_citations }` |

- 成功返回（关键字段）

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| answer | string | 生成答案 |
| citations[] | array | 证据引用 |
| citations[].doc_id | string | 文档ID |
| citations[].chunk_id | string | 文档块ID |
| citations[].modality | string | `text`/`image`/`table` |
| citations[].loc | object | 定位（页码/表格范围/图像区域） |

---

## 作业二：文本提问 和 文本+图提问

| 维度 | 文本提问（Text-only） | 文本+图提问（Text+Image） |
| --- | --- | --- |
| 预处理 | 无 | 对查询图 OCR+Caption，生成辅助文本 |
| 编码 | 文本编码（bge） | 文本编码 + 图像编码（CLIP） |
| 召回 | text_chunks + table_chunks | 文→text/table，图→image（以图搜图） |
| 融合 | 文本为主，可加 BM25 | 分数归一化 + 权重融合；可用 VLM 重排 |
| 生成 | 文本 LLM | 多模态 LLM（如 Qwen-VL），返回区域/范围 |
| 降级 | — | 图像质量差→仅用 OCR/caption 文本检索 |

---

## 作业三：Milvus 数据设计

### text_chunks（文本集合）

| 字段名     | 数据类型          | 必填 | 描述                                    | 示例                          |
| ---------- | ----------------- | ---- | --------------------------------------- | ----------------------------- |
| id         | Int64（PK）       | 是   | 主键，自增或外部分配                    | 10001                         |
| dataset_id | VarChar(64)       | 是   | 数据集ID，作为分区键                    | ds_gov_2024                   |
| doc_id     | VarChar(64)       | 是   | 文档ID                                  | doc_t_001                     |
| chunk_id   | VarChar(64)       | 是   | 文本块ID                                | c_12                          |
| text_vec   | FloatVector(1024) | 是   | 文本嵌入向量（bge-m3）                  | —                             |
| text       | VarChar(max)      | 否   | 原文/摘要（可外部存储，仅索引关键字段） | "……退税结构包括……"            |
| metadata   | VarChar/JSON      | 否   | 自定义元信息（dept/lang/date 等）       | {"dept":"财政部","lang":"zh"} |
| page       | Int64             | 否   | 页码                                    | 2                             |
| lang       | VarChar(8)        | 否   | 语言                                    | zh                            |
| created_at | Int64             | 否   | 时间戳(ms)                              | 1719830400000                 |

- 分区策略：按 `dataset_id` 建分区，便于按库加载/查询。

---

### image_chunks（图像集合）

| 字段名     | 数据类型              | 必填 | 描述                       | 示例             |
| ---------- | --------------------- | ---- | -------------------------- | ---------------- |
| id         | Int64（PK）           | 是   | 主键                       | 20001            |
| dataset_id | VarChar(64)           | 是   | 数据集ID（分区键）         | ds_gov_2024      |
| doc_id     | VarChar(64)           | 是   | 文档/图片来源ID            | doc_i_002        |
| chunk_id   | VarChar(64)           | 是   | 图块ID（整图可 i_full）    | i_full           |
| image_vec  | FloatVector(768/1024) | 是   | 图像嵌入（CLIP ViT-L/14）  | —                |
| caption    | VarChar(max)          | 否   | 图像描述（Caption）        | "税收退税示意图" |
| ocr_text   | VarChar(max)          | 否   | 图像OCR文本                | "2024 退税 …"    |
| metadata   | VarChar/JSON          | 否   | 元信息（如 page/topic 等） | {"page":3}       |
| created_at | Int64                 | 否   | 时间戳(ms)                 | 1719830400000    |

---

### table_chunks（表格集合）

| 字段名     | 数据类型             | 必填 | 描述                             | 示例                             |
| ---------- | -------------------- | ---- | -------------------------------- | -------------------------------- |
| id         | Int64（PK）          | 是   | 主键                             | 30001                            |
| dataset_id | VarChar(64)          | 是   | 数据集ID（分区键）               | ds_gov_2024                      |
| doc_id     | VarChar(64)          | 是   | 文档ID                           | doc_tb_003                       |
| chunk_id   | VarChar(64)          | 是   | 表格片段ID（行/列范围）          | t_rows_10_20                     |
| table_vec  | FloatVector(512/768) | 是   | 表格嵌入（结构化或文本化嵌入）   | —                                |
| table_text | VarChar(max)         | 否   | 表格文本化（含标题/表头/单元值） | "行业A 退税:3.2 …"               |
| range      | VarChar(64)          | 否   | 范围定位                         | "sheet=2024;rows=10-20;cols=A-G" |
| metadata   | VarChar/JSON         | 否   | 元信息                           | {"unit":"亿元"}                  |
| created_at | Int64                | 否   | 时间戳(ms)                       | 1719830400000                    |

---

### 写入与查询动作

| 步骤 | 动作     | 说明                                                         |
| ---- | -------- | ------------------------------------------------------------ |
| 1    | 文档解析 | mineru / DeepSeek-OCR → Markdown+图片；表格标准化            |
| 2    | 分块     | 文本 token=512, overlap=64；表格按区域切块；图像为整图或区域 |
| 3    | 嵌入     | 文本 bge-m3；图像 CLIP；表格文本化后 bge 或结构化编码器      |
| 4    | 写入     | 先 RDBMS 写元信息（可选），批量写 Milvus（集合=按模态）      |
| 5    | 索引     | 批量入库后统一建索引；按 `dataset_id` 分区加载               |
| 6    | 查询     | 分模态 TopK → 分数归一化 → 权重融合 → 重排 → 返回定位        |
