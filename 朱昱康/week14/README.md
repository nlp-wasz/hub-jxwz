# RAG公式解析与智能问答系统

本项目实现了一个基于RAG（检索增强生成）框架的公式解析与智能问答系统，能够根据用户问题自动选择最相关的计算工具并执行计算。

## 系统架构

系统包含以下核心组件：

1. **工具函数库** (`tools.py`)：包含11个不同领域的计算工具函数
2. **RAG工具选择器** (`rag_tool_selector.py`)：基于TF-IDF和余弦相似度计算用户问题与工具函数的相似度
3. **MCP服务定义** (`mcp_service.py`)：将每个工具函数定义为MCP可执行的计算工程
4. **RAG问答系统** (`rag_qa_system.py`)：整合RAG筛选和MCP执行，完成整个问答流程

## 可用工具

系统包含以下11个计算工具：

1. **基础代谢率计算** (`get_bmr_rate`)
   - 计算个体在静息状态下维持基本生理功能所需能量的重要指标
   - 参数：体重(weight)、身高(height)

2. **农产品日销售额预测** (`predict_daily_sales`)
   - 预测农产品的日销售总额，考虑价格、供应量、市场需求、促销活动以及天气等因素
   - 参数：价格(price_per_kg)、供应量(supply_kg)、需求系数(demand_factor)、折扣率(discount_rate)、天气因子(weather_factor)

3. **房产月租金预测** (`calculate_monthly_rent`)
   - 预测房产的潜在月租金收益，考虑面积、地段评分、房龄、卧室数量和交通便利性等因素
   - 参数：面积(area)、地段评分(location_score)、房龄(age)、卧室数量(bedrooms)、距离地铁距离(distance_to_subway)

4. **复杂系统分析** (`calculate_complex_system`)
   - 模拟两个输入变量对某一目标输出的综合影响，包含周期性变化与线性交互的成分
   - 参数：变量x、变量y

5. **溶解氧浓度变化计算** (`calculate_do_concentration_change`)
   - 基于扩散-反应机制，预测水产养殖系统中溶解氧浓度的动态变化
   - 参数：当前浓度(C)、扩散系数(D)、气体交换速率(k)、饱和浓度(C_sat)、生物负载(bio_load)、水温(temp)、空间位置(x)、时间(t)

6. **奶牛产奶量预测** (`calculate_milk_production`)
   - 预测奶牛的日均产奶量，考虑饲料质量、健康状况、泌乳周期、环境温度和挤奶频率等因素
   - 参数：饲料质量(feed_quality)、健康状况(health_status)、平均温度(avg_temp)、挤奶频率(milk_freq)、泌乳周数(lactation_week)

7. **复杂积分模型计算** (`calculate_complex_integral_model`)
   - 描述多变量输入的复杂系统，包含随时间或空间累积的动态效应
   - 参数：积分上限(x1)、二次项(x2)、周期性项(x3)、对数项(x4)、幂律项(x5)、系数(a,b,c,d,e)

8. **确定性模型计算** (`calculate_deterministic_model`)
   - 基于已知数学关系，将多个输入变量通过预定义公式转换为输出结果
   - 参数：变量x1、x2、x3、x4

9. **溶解氧动态变化** (`calculate_do_dynamics`)
   - 模拟水产养殖系统中溶解氧浓度随时间演变的过程
   - 参数：时间(t)、初始释放量(a)、衰减系数(b)、振幅(c)、频率(d)

10. **电商订单预测** (`predict_ecommerce_orders`)
    - 预测每日订单增长量，考虑广告支出、折扣力度和前一日的订单量等因素
    - 参数：广告支出(ad_spend)、折扣率(discount_rate)、前一日的订单量(prev_orders)、系数(alpha,beta,gamma)

11. **农作物产量预测** (`predict_crop_yield`)
    - 预测农作物产量，考虑温度、降水量、施肥量、光照时长和土壤质量等因素
    - 参数：温度(temp)、降水量(rainfall)、施肥量(fertilizer)、光照时长(sunlight)、土壤质量(soil_quality)、基础产量(base_yield)

## 使用方法

### 命令行界面

```bash
# 安装依赖
pip install -r requirements.txt

# 运行命令行界面
python rag_qa_system.py
```

## RAG工作流程

系统按照以下流程处理用户查询：

1. **问题分析**：使用jieba对用户问题进行分词
2. **工具检索**：基于TF-IDF和余弦相似度计算，从工具库中检索最相关的工具
3. **参数提取**：使用正则表达式从用户问题中提取工具所需的参数
4. **参数验证**：检查是否所有必需参数都已提供
5. **工具执行**：调用MCP服务执行选定的工具函数
6. **结果返回**：格式化并返回计算结果

## 交互方式

系统提供两种交互方式：

### 1. 直接查询

直接输入完整问题，系统会自动选择工具并提取参数：

```
请输入您的问题: 计算一个体重70kg、身高175cm的人的基础代谢率
```

### 2. 交互式查询

当系统无法从问题中提取所有必需参数时，可以使用交互式查询：

```
请输入您的问题: interactive_query('计算基础代谢率', {"weight": 70, "height": 175})
```

## 示例查询

1. **基础代谢率计算**
   - 查询："计算一个体重70kg、身高175cm的人的基础代谢率"
   - 系统会自动选择`get_bmr_rate`工具并提取参数weight=70, height=175

2. **农产品销售预测**
   - 查询："如果农产品价格是5元/kg，供应量100kg，需求系数0.8，折扣率0.1，天气因子1.0，预测日销售额"
   - 系统会自动选择`predict_daily_sales`工具并提取相应参数

3. **房产租金预测**
   - 查询："一个面积80平方米，地段评分8分，房龄5年，有2间卧室，距离地铁500米的房子，月租金是多少"
   - 系统会自动选择`calculate_monthly_rent`工具并提取相应参数

## 技术实现细节

### RAG工具选择器

- 使用TF-IDF向量化工具描述和关键词
- 计算用户查询与工具描述的余弦相似度
- 返回相似度最高的top-k个工具

### 参数提取

- 使用多种正则表达式模式匹配参数值
- 支持多种表达方式（如："参数: 值"、"参数是值"、"值为参数"等）
- 自动类型转换为数值

### MCP服务

- 定义标准化的工具接口
- 统一参数验证和错误处理
- 支持动态工具加载和执行

## 扩展性

系统设计具有良好的扩展性：

1. **添加新工具**：在`tools.py`中添加新函数，并在`rag_tool_selector.py`和`mcp_service.py`中注册
2. **改进相似度计算**：可以替换TF-IDF为更先进的嵌入模型（如BERT）
3. **增强参数提取**：可以使用NLP模型提高参数提取的准确性

## 注意事项

1. 确保安装所有依赖：`pip install -r requirements.txt`
2. 工具函数中的参数验证很重要，可以防止无效输入导致错误
3. 对于复杂查询，系统可能无法准确提取所有参数，此时可以使用交互式查询模式手动提供参数